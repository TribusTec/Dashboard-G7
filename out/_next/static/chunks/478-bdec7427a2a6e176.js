"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[478],{45478:function(e,o,t){t.d(o,{AuthProvider:function(){return m},a:function(){return f}});var r=t(57437),a=t(2265),n=t(99376),i=t(41121),s=t(14438),c=t(43301),l=t(52395),u=t(17292);let d=(0,a.createContext)(void 0),h=["/"];function m(e){let{children:o}=e,[t,m]=(0,a.useState)(null),[f,g]=(0,a.useState)(null),[p,w]=(0,a.useState)(!0),[y,v]=(0,a.useState)(!1),[E,b]=(0,a.useState)(!1),k=(0,n.useRouter)(),T=(0,n.usePathname)();(0,a.useEffect)(()=>{b(!0)},[]),(0,a.useEffect)(()=>{if(!E)return;let e=(0,c.Aj)(l.I8,async e=>{try{if(e){console.log("Firebase user detected:",e.email);let o=(0,u.iH)(l.Fs,"users/".concat(e.uid)),t=await (0,u.U2)(o);if(t.exists()&&t.val().isAdmin){let o=t.val(),r=await e.getIdToken();await (0,i.pC)(r),m({id:e.uid,email:e.email||"",name:o.nome||e.displayName||"",role:"admin"}),g(r),"/"===T&&k.push("/Dashboard")}else console.warn("User is not an admin"),await (0,i.H6)(),m(null),g(null),h.includes(T)||k.push("/")}else console.log("No Firebase user detected"),await (0,i.H6)(),m(null),g(null),h.includes(T)||k.push("/")}catch(e){console.error("Error in auth state change:",e),await (0,i.H6)(),m(null),g(null),h.includes(T)||k.push("/")}finally{w(!1)}});return()=>e()},[E,T,k]);let S=async(e,o)=>{w(!0),v(!0);try{var t;let r=(await (0,c.e5)(l.I8,e,o)).user,a=(0,u.iH)(l.Fs,"users/".concat(r.uid)),n=await (0,u.U2)(a);if(!n.exists())throw Error("User data not found in database");let d=n.val();if(!d.isAdmin)throw Error("Unauthorized: Admin access required");let h=await r.getIdToken();await (0,i.pC)(h);let f={id:r.uid,email:null!==(t=r.email)&&void 0!==t?t:"",name:d.nome||r.displayName||"",role:"admin"};return m(f),g(h),s.A.success("Login bem-sucedido!",{description:"Redirecionando para o painel...",duration:3e3}),E&&"true"===localStorage.getItem("rememberMe")&&localStorage.setItem("savedEmail",e),setTimeout(()=>{k.push("/Dashboard")},1e3),r}catch(e){if(console.error("Login error:",e),"Unauthorized: Admin access required"===e.message)throw Error("Acesso n\xe3o autorizado: apenas administradores podem acessar este painel");if("auth/invalid-credential"===e.code||"auth/user-not-found"===e.code||"auth/wrong-password"===e.code)throw Error("Email ou senha incorretos");if("auth/too-many-requests"===e.code)throw Error("Muitas tentativas. Tente novamente mais tarde");throw e}finally{w(!1),setTimeout(()=>{v(!1)},500)}},I=async()=>{v(!0);try{await l.I8.signOut(),await (0,i.H6)(),m(null),g(null),E&&localStorage.removeItem("rememberMe"),s.A.success("Logout realizado com sucesso!"),k.push("/")}catch(e){console.error("Erro ao fazer logout:",e)}finally{setTimeout(()=>{v(!1)},500)}},A={user:t,token:f,isLoading:p,isAuthenticated:!!t&&!!f&&"admin"===t.role,showLoadingTransition:y,setShowLoadingTransition:v,login:S,logout:I};return(0,r.jsx)(d.Provider,{value:A,children:o})}function f(){let e=(0,a.useContext)(d);if(void 0===e)throw Error("useAuth deve ser usado dentro de um AuthProvider");return e}},52395:function(e,o,t){t.d(o,{Fs:function(){return c},I8:function(){return s}});var r=t(738),a=t(43301),n=t(17292);let i=(0,r.ZF)({apiKey:"AIzaSyBvWq79anFVSR27hCJIlHlLHFftYl3WUu8",authDomain:"g7-medico-889d4.firebaseapp.com",databaseURL:"https://g7-medico-889d4-default-rtdb.firebaseio.com",projectId:"g7-medico-889d4",storageBucket:"g7-medico-889d4.firebasestorage.app",messagingSenderId:"461248323545",appId:"1:461248323545:web:30639b8c81a90497cb83c8"}),s=(0,a.v0)(i),c=(0,n.N8)(i);o.ZP=i},41121:function(e,o,t){t.d(o,{H6:function(){return n},hi:function(){return l},pC:function(){return a}});var r=t(43301);let a=async function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:86400;try{let t=Date.now()+1e3*o;localStorage.setItem("auth_token",JSON.stringify({token:e,expiresAt:t}))}catch(e){console.error("Erro ao salvar token de autentica\xe7\xe3o:",e)}},n=async()=>{try{localStorage.removeItem("auth_token")}catch(e){console.error("Erro ao remover token de autentica\xe7\xe3o:",e)}},i=()=>{{let e=localStorage.getItem("auth_token");if(e)try{let o=JSON.parse(e),{token:t,expiresAt:r}=o;if(Date.now()>r)return console.warn("Token expirado, removendo..."),localStorage.removeItem("auth_token"),null;return o}catch(e){console.error("Erro ao fazer parse do token:",e),localStorage.removeItem("auth_token")}}return null},s="https://api-zwx65dnexa-uc.a.run.app/api";async function c(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=i(),r={"Content-Type":"application/json",...o.headers};t&&t.token?r.Authorization="Bearer ".concat(t.token):console.warn("Token n\xe3o encontrado ou expirado - fazendo requisi\xe7\xe3o sem autentica\xe7\xe3o"),console.log("Fazendo requisi\xe7\xe3o para: ".concat(s).concat(e),{method:o.method||"GET",headers:r,body:o.body?"string"==typeof o.body?JSON.parse(o.body):o.body:void 0});try{let t=new AbortController,a=setTimeout(()=>t.abort(),1e4),n=await fetch("".concat(s).concat(e),{...o,headers:r,signal:t.signal});if(clearTimeout(a),!n.ok){let e;if(401===n.status)throw console.error("Erro de autentica\xe7\xe3o: Token inv\xe1lido ou expirado"),localStorage.removeItem("auth_token"),Error("\uD83D\uDD12 Sess\xe3o expirada. Por favor, fa\xe7a login novamente.");try{e=await n.json(),console.error("Detalhes do erro:",e),e.error&&console.error("Erro espec\xedfico:",e.error),e.validationErrors&&console.error("Erros de valida\xe7\xe3o:",e.validationErrors)}catch(e){console.error("N\xe3o foi poss\xedvel obter detalhes do erro")}let o=(null==e?void 0:e.message)||"Erro na requisi\xe7\xe3o: ".concat(n.status," ").concat(n.statusText),t=Error(o);throw e&&(t.details=e),t}let i=await n.json();return console.log("Dados recebidos (".concat(e,"):"),i),i}catch(o){throw console.error("Erro na requisi\xe7\xe3o para ".concat(e,":"),o),o}}let l={auth:{login:async(e,o)=>{try{let t=await fetch("".concat(s,"/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:o})});if(!t.ok)throw Error("Authentication failed");let r=await t.json();return r.token&&await a(r.token),r}catch(e){throw console.error("Login API error:",e),e}},verify:()=>c("/auth/verify")},trails:{create:async(e,o)=>{try{let o=(0,r.v0)().currentUser;if(!o)throw Error("Usu\xe1rio n\xe3o autenticado");let t=await o.getIdToken(!0);e.id||(e.id="trilha_".concat(Date.now()));let a={id:e.id,nome:e.nome||"Nova Trilha",descricao:e.descricao||"",etapas:e.etapas||[],backgroundSvg:e.backgroundSvg||""};console.log("Enviando trilha para API:",a);let n=await fetch("".concat("https://g7-medico-889d4-default-rtdb.firebaseio.com","/trilhas/").concat(e.id,".json?auth=").concat(t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!n.ok)throw Error("Erro ao criar trilha: "+n.statusText);let i=await n.json();return console.log("Trilha criada com sucesso:",i),i}catch(e){throw console.error("Erro ao criar trilha:",e),e}},getAll:async()=>{let e=await c("/trails");if(e&&200===e.status&&Array.isArray(e.data));else if(Array.isArray(e))return{status:200,message:"Trilhas encontradas com sucesso",count:e.length,data:e};return e},getById:e=>c("/trails/".concat(e)),delete:async(e,o)=>{try{let o=(0,r.v0)().currentUser;if(!o)throw Error("Usu\xe1rio n\xe3o autenticado");let t=await o.getIdToken(),a=await fetch("".concat("https://g7-medico-889d4-default-rtdb.firebaseio.com","/trilhas/").concat(e,".json?auth=").concat(t),{method:"DELETE"});if(!a.ok)throw Error("Erro ao deletar trilha: "+a.statusText);return console.log("Trilha deletada com sucesso!"),!0}catch(e){throw console.error("Erro ao excluir trilha do Firebase:",e),e}},update:async(e,o,t)=>{try{let t=(0,r.v0)().currentUser;if(!t)throw Error("Usu\xe1rio n\xe3o autenticado");let a=await t.getIdToken(!0);console.log("Atualizando trilha com ID:",e),console.log("Dados enviados:",JSON.stringify(o,null,2));let n=await fetch("".concat("https://g7-medico-889d4-default-rtdb.firebaseio.com","/trilhas/").concat(e,".json?auth=").concat(a),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok)throw Error("Erro ao atualizar trilha: "+n.statusText);let i=await n.json();return console.log("Trilha atualizada com sucesso:",i),i}catch(e){throw console.error("Erro ao atualizar trilha:",e),Error("Erro ao atualizar trilha: ".concat(e instanceof Error?e.message:String(e)))}}}}}}]);